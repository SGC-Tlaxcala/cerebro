{% load static %}
<!DOCTYPE html>
<html lang="es" data-theme="valentine">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMI Móvil</title>
    <!-- Carga del Manifiesto -->
    <script src="manifest.js"></script>
    <!-- Local Assets -->
    <script src="assets/tailwind.min.js"></script>
    <link href="assets/daisyui.min.css" rel="stylesheet" type="text/css" />

    <style>
        /* Custom Overrides only if needed */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--p);
            /* Primary color from daisyui */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .clickable {
            cursor: pointer;
        }

        .clickable:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
    </style>
</head>

<body class="min-h-screen bg-base-200">
    <div class="container mx-auto p-4">
        <!-- Bloqueo por Expiración -->
        <div id="expirationBlock" class="hidden">
            <div class="alert alert-error shadow-lg">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <div>
                        <h3 class="font-bold">Versión Obsoleta</h3>
                        <div class="text-xs">Esta copia del CMI Portátil ha expirado (Vigencia: 15 días). Solicite una nueva versión.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerta de Integridad Comprometida (Index) -->
        <div id="integrityAlert" class="hidden mb-4">
            <div class="alert alert-error shadow-lg">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <div>
                        <h3 class="font-bold">⚠️ HERRAMIENTA ALTERADA</h3>
                        <div class="text-xs">Integridad comprometida: El código de este visor no coincide con el manifiesto oficial.</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="mainApp" class="space-y-6">
            <header class="text-center py-6 flex flex-col items-center gap-4">
                <img src="assets/logo.svg" alt="SGC Logo" style="height: 150px;" class="w-auto object-contain">
                <h1 class="text-4xl font-bold text-primary">CMI Móvil</h1>
                <p id="versionInfo" class="text-secondary mt-2 font-mono text-sm"></p>

                <!-- Filters & Search -->
                <div id="searchFilterSection" class="w-full max-w-2xl px-4 flex flex-col gap-4 hidden">
                    <input type="text" id="searchInput" placeholder="Buscar por nombre de documento..." class="input input-bordered w-full" />

                    <div id="process-filters" class="flex flex-wrap gap-2 my-4">
                        <!-- Badges injected via JS -->
                    </div>
                </div>
            </header>

            <!-- Sección de Montaje -->
            <div class="card bg-base-100 shadow-xl" id="mountSection">
                <div class="card-body text-center items-center">
                    <h2 class="card-title">1. Sincronización</h2>
                    <p>Haga clic en el botón y seleccione la carpeta que contiene el CMI Portátil.</p>
                    <div class="card-actions justify-center mt-4">
                        <button class="btn btn-primary btn-wide" id="btnSync" onclick="document.getElementById('dirInput').click()">
                            Sincronizar Directorio SGC
                        </button>
                    </div>
                    <input type="file" id="dirInput" webkitdirectory directory multiple class="hidden">
                    <div id="step1-spinner" class="hidden mt-4">
                        <span class="loading loading-spinner loading-lg text-primary"></span>
                        <p class="text-xs mt-2">Analizando archivos...</p>
                    </div>
                </div>
            </div>

            <!-- Listado de Archivos -->
            <div class="card bg-base-100 shadow-xl hidden" id="listSection">
                <div class="card-body">


                    <div class="alert alert-warning shadow-lg hidden mb-4" id="fileErrorAlert">
                        <div>
                            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            <span id="fileErrorText"></span>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="table table-zebra w-full">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Proceso</th>
                                    <th>Tipo</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="fileListBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Process Modal (DaisyUI) -->
    <input type="checkbox" id="process_modal_toggle" class="modal-toggle" />
    <div class="modal" id="processModal" role="dialog">
        <div class="modal-box text-center">
            <h3 class="font-bold text-lg mb-4">Validando Integridad</h3>
            <div class="flex justify-center mb-4">
                <img id="processImg" class="w-24 h-24 object-contain" src="" alt="Procesando...">
            </div>
            <p id="processText" class="py-4 text-xl font-semibold"></p>
            <div class="modal-action justify-center hidden" id="modalCloseAction">
                <button class="btn btn-sm" onclick="closeProcessModal()">Cerrar</button>
            </div>
        </div>
    </div>
    <!-- Script para compatibilidad de cierre manual -->
    <script>
        function openProcessModal() { document.getElementById('process_modal_toggle').checked = true; }
        function closeProcessModal() { document.getElementById('process_modal_toggle').checked = false; }
    </script>

    <!-- Success Modal (DaisyUI Alert inside Modal or just Alert) -->
    <!-- Reutilizamos el modal de proceso para éxito o añadimos uno nuevo si se prefiere. 
         Por simplicidad, mantendré el Success Modal aparte como DaisyUI Modal. -->
    <input type="checkbox" id="success_modal_toggle" class="modal-toggle" />
    <div class="modal">
        <div class="modal-box text-center">
            <h3 class="text-success text-2xl font-bold">✅ Validación Exitosa</h3>
            <p class="py-4">Archivo válido y vigente.</p>
            <div class="modal-action justify-center">
                <label for="success_modal_toggle" class="btn btn-primary">Aceptar</label>
            </div>
        </div>
    </div>

    <script>
        // --- Constantes y Configuración ---
        const BUILD_DATE_STR = "{{ build_date|date:'c' }}";
        const BUILD_DATE = new Date(BUILD_DATE_STR);
        const EXPIRATION_DATE_STR = "{{ expiration_date|date:'c' }}";
        const EXPIRATION_DATE = new Date(EXPIRATION_DATE_STR);

        let fileMap = new Map();
        let activeProcessFilter = 'Todos';

        // --- Ciclo de Vida: Inicio ---
        (function init() {
            // Verificar Expiración
            const now = new Date();
            const timeLeft = EXPIRATION_DATE - now;
            const daysLeft = Math.ceil(timeLeft / (1000 * 60 * 60 * 24));

            document.getElementById('versionInfo').textContent = `Generado: ${BUILD_DATE.toLocaleDateString()} | Vence: ${EXPIRATION_DATE.toLocaleDateString()} (${Math.max(0, daysLeft)} días)`;

            if (now > EXPIRATION_DATE) {
                document.getElementById('expirationBlock').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('opacity-50', 'pointer-events-none'); // Deshabilitar visualmente
                document.getElementById('btnSync').disabled = true;
            }

            // Visibilidad Inmediata: Generar badges al cargar (usando manifest.js cargado)
            generateProcessBadges();
        })();

        async function showStep(gifName, text) {
            const img = document.getElementById('processImg');
            const txt = document.getElementById('processText');
            const action = document.getElementById('modalCloseAction');

            // Asegurar que el modal esté abierto
            openProcessModal();
            action.classList.add('hidden'); // Ocultar cerrar

            img.style.display = 'block';
            img.src = 'assets/' + gifName;

            txt.textContent = text;
            txt.className = "py-4 text-xl font-semibold"; // Reset class

            await new Promise(resolve => setTimeout(resolve, 1000));
        }

        // --- Manejador de Archivos (Directory Picker via Input) ---
        document.getElementById('dirInput').addEventListener('change', async (event) => {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            fileMap.clear();
            let indexFile = null;

            for (let file of files) {
                const parts = file.webkitRelativePath.split('/');
                if (parts.length > 1) {
                    const relativeKey = parts.slice(1).join('/');
                    fileMap.set(relativeKey, file);

                    if (relativeKey === 'index.html') {
                        indexFile = file;
                    }
                }
            }

            // 3. Renderizar Lista (Inmediato)
            renderFileList();
            generateProcessBadges();
            document.getElementById('mountSection').classList.add('hidden');
            document.getElementById('listSection').classList.remove('hidden');
            document.getElementById('searchFilterSection').classList.remove('hidden');

            // 2. Auto-Verificación del Index (Secuencia Visual)
            if (indexFile && typeof SGC_MANIFEST !== 'undefined' && SGC_MANIFEST['index.html']) {
                try {
                    // Paso 1
                    await showStep('scanning.gif', 'Verificando vigencia...');

                    // Paso 2
                    await showStep('fingerprint.gif', 'Verificando huella digital...');
                    const buffer = await indexFile.arrayBuffer();
                    const hash = await cryptoHashArrayBuffer(buffer);

                    if (hash === SGC_MANIFEST['index.html'].hash) {
                        // Paso 3
                        await showStep('ok.gif', 'Herramienta válida');
                        closeProcessModal();

                        console.log("Index integrity verified.");
                        document.getElementById('success_modal_toggle').checked = true;
                    } else {
                        closeProcessModal();
                        document.getElementById('integrityAlert').classList.remove('hidden');
                        document.getElementById('mountSection').classList.add('hidden');
                        console.error(`Hash mismatch! Expected ${SGC_MANIFEST['index.html'].hash}, got ${hash}`);
                        // return; // Bloqueo eliminado
                    }
                } catch (e) {
                    console.error("Error leyendo index.html:", e);
                    closeProcessModal();
                }
            } else {
                console.warn("index.html no encontrado en la selección para autoverificación.");
            }

            // (Renderizado movido al inicio)
        });



        function generateProcessBadges() {
            if (typeof SGC_MANIFEST === 'undefined') return;

            const processes = {};
            let totalDocs = 0;

            Object.keys(SGC_MANIFEST).forEach(key => {
                if (key === 'index.html' || key === 'manifest.js') return;
                totalDocs++;
                const proc = SGC_MANIFEST[key].proceso || 'General';
                processes[proc] = (processes[proc] || 0) + 1;
            });

            const container = document.getElementById('process-filters');
            if (container) {
                container.innerHTML = '';

                // "Todos" Badge
                container.innerHTML += `<span class="badge ${activeProcessFilter === 'Todos' ? 'badge-primary' : 'badge-outline'} cursor-pointer" onclick="filterByProcess('Todos')">Todos (${totalDocs})</span>`;

                // Process Badges
                Object.keys(processes).sort().forEach(proc => {
                    const isActive = activeProcessFilter === proc;
                    const badgeClass = isActive ? 'badge-primary' : 'badge-outline';
                    container.innerHTML += `<span class="badge ${badgeClass} cursor-pointer" onclick="filterByProcess('${proc}')">${proc} (${processes[proc]})</span>`;
                });
            }
        }

        function filterByProcess(proc) {
            activeProcessFilter = proc;
            generateProcessBadges(); // Re-render for active state visual feedback
            applyFilters();
        }

        function applyFilters() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#fileListBody tr');

            rows.forEach(row => {
                const nameEl = row.querySelector('td:nth-child(1)');
                const procEl = row.querySelector('td:nth-child(2)');

                if (!nameEl || !procEl) return;

                const name = nameEl.textContent.toLowerCase();
                const proceso = procEl.textContent;

                const matchesTerm = name.includes(term);
                const matchesProc = activeProcessFilter === 'Todos' || proceso === activeProcessFilter;

                if (matchesTerm && matchesProc) {
                    row.classList.remove('hidden');
                } else {
                    row.classList.add('hidden');
                }
            });
        }

        // Input Listener
        const searchInp = document.getElementById('searchInput');
        if (searchInp) searchInp.addEventListener('input', applyFilters);

        function renderFileList() {
            const tbody = document.getElementById('fileListBody');
            tbody.innerHTML = '';

            if (typeof SGC_MANIFEST === 'undefined') return;

            Object.keys(SGC_MANIFEST).forEach(path => {
                // Ignorar index.html y manifest.js
                if (path === 'index.html' || path === 'manifest.js') return;

                const tr = document.createElement('tr');
                tr.classList.add('hover', 'cursor-pointer');

                const meta = SGC_MANIFEST[path];
                const hasFile = fileMap.has(path);

                // Icono Sincronizado (Lock Closed - Rojo)
                const syncIcon = `
                <div class="tooltip" data-tip="Sincronizado">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-error" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
                    </svg>
                </div>`;

                // Icono No Encontrado (Gris)
                const missingIcon = `
                <div class="tooltip" data-tip="No encontrado">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-base-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>`;

                const statusHtml = hasFile ? syncIcon : missingIcon;

                // Render con nuevos campos: Nombre, Proceso, Tipo
                const nombre = meta.nombre || path.split('/').pop();
                const proceso = meta.proceso || '-';
                const tipo = meta.tipo || 'DOC';

                tr.innerHTML = `
                    <td><div class="font-bold text-sm text-left">${nombre}</div></td>
                    <td class="text-xs text-left">${proceso}</td>
                    <td><div class="badge badge-outline text-xs">${tipo}</div></td>
                    <td><span id="status-${btoa(path)}">${statusHtml}</span></td>
                `;

                if (hasFile) {
                    const file = fileMap.get(path);
                    const expectedHash = meta.hash;
                    tr.addEventListener('click', () => runValidationSequence(file, expectedHash, path));
                }

                tbody.appendChild(tr);
            });
        }

        async function runValidationSequence(file, expectedHash, relativePath) {
            const alertBox = document.getElementById('fileErrorAlert');
            alertBox.classList.add('hidden');

            try {
                // --- Paso 1: Vigencia ---
                await showStep('scanning.gif', 'Verificando vigencia del archivo...');
                const now = new Date();
                if (now > EXPIRATION_DATE) {
                    throw new Error("CERTIFICADO EXPIRADO: La vigencia de 15 días ha concluido.");
                }

                // --- Paso 2: Huella Digital ---
                await showStep('fingerprint.gif', 'Verificando huella digital...');

                let arrayBuffer = await file.arrayBuffer();
                const hash = await cryptoHashArrayBuffer(arrayBuffer);

                // Liberar memoria (Best effort en JS)
                arrayBuffer = null;

                if (hash !== expectedHash) {
                    throw new Error("MODIFICACIÓN DETECTADA: La huella digital no coincide.");
                }

                // --- Paso 3: Resultado Exitoso ---
                await showStep('ok.gif', 'Archivo válido');

                // Cerrar modal y actualizar estado
                closeProcessModal();
                updateStatus(relativePath, true); // true = valid

                // Abrir archivo
                const url = URL.createObjectURL(file);
                window.open(url, '_blank');

                // Limpieza de ObjectURL
                setTimeout(() => URL.revokeObjectURL(url), 60000);

            } catch (err) {
                console.error(err);

                const txt = document.getElementById('processText');
                txt.textContent = err.message;
                txt.className = "py-4 text-xl font-semibold text-error"; // Error color

                const img = document.getElementById('processImg');
                img.style.display = 'none';

                // Mostrar botón de cierre para que el usuario pueda salir del estado de error
                document.getElementById('modalCloseAction').classList.remove('hidden');

                updateStatus(relativePath, false); // false = invalid

                // Mostrar error en lista también (opcional)
                document.getElementById('fileErrorText').textContent = err.message;
                document.getElementById('fileErrorAlert').classList.remove('hidden');
            }
        }

        // --- Helpers ---
        function updateStatus(path, isValid) {
            const el = document.getElementById(`status-${btoa(path)}`);
            if (el) {
                if (isValid) {
                    // Shield Check (Verde)
                    el.innerHTML = `
                    <div class="tooltip" data-tip="Válido">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-success" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                    </div>`;
                } else {
                    // Shield Exclamation (Rojo)
                    el.innerHTML = `
                    <div class="tooltip" data-tip="Corrupto">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-error" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>`;
                }
            }
        }

        async function cryptoHashArrayBuffer(buffer) {
            const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function cryptoHash(text) {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            return await cryptoHashArrayBuffer(data);
        }
    </script>
</body>

</html>