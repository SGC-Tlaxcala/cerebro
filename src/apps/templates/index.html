{% extends 'base.html' %}

{% block head_title %}Cuadro de Mando Integral{% endblock head_title %}

{% block content %}
<div class="row position-relative overflow-hidden text-center mb-5">
  <div class="col my-5">
    <form class="form" method="get" action="{% url 'docs:buscador' %}">
      <div class="input-group mb-3">
        <input type="text" class="form-control py-3" name="q" placeholder="Escribe el documento a buscar" aria-label="Nombre del documento" aria-describedby="button-addon2">
        <button class="btn btn-primary" type="button" id="button-addon2"><i class="fa fa-search"></i></button>
      </div>
    </form>
  </div>
</div>

  <div class="row mt-4">
    <div class="col mx-auto my-8 bg-secondary rounded-5 p-5">
      <h1 class="display-5 font-weight-normal text-primary">Política de la Calidad</h1>
      <p class="lead text-primary mx-auto">
        En el Instituto Nacional Electoral INE, estamos comprometidos en proporcionar
        a la ciudadanía un servicio eficiente y de calidad en el trámite de expedición
        de su credencial para votar, desde la entrevista hasta la entrega de la
        credencial para votar, para contribuir al derecho a la identidad ciudadana,
        con base en el marco normativo, reglamentario y en un entorno de mejora continua
        con apego a los requisitos de la norma ISO 9001:2015.<br>
        <span class="text-muted small">Revisión: 00 - 2021</span>
      </p>
    </div>
  </div>

<div class="row mt-4">
  <div class="col">
    <h1 class="display-5">Alcance del Sistema</h1>
    <p class="lead p-3 mb-2 bg-primary text-white rounded-3">
      Dar un Servicio de Atención a la Ciudadanía durante el trámite de
      expedición de su credencial para votar, dese la primera
      entrevista hasta la entrega de la credencial en los MAC en la
      entidad.
    </p>
  </div>
</div>

<div class="row mt-4">
  <div class="col">
    <h1 class="display-5">Objetivos de la calidad</h1>
  </div>
</div>

  <!-- Objetivo 1 -->
  <div class="row row-cols-md-3 g-4">
    <div class="col d-flex align-items-stretch">
      <div class="card">
        <div class="card-body">
          <p class="lead">
            1. Actualizar el Padrón Electoral en la entidad mediante
            la captación de solicitudes de credencial requeridas por
            la ciudadanía en los Módulos de Atención Ciudadana en al
            menos el 90% del rango mínimo establecido en el pronóstico.
          </p>
          <!-- Button to trigger modal -->
          <button type="button" class="btn btn-outline-primary btn-lg" data-bs-toggle="modal" data-bs-target="#kpi1">
            {{ cap }}
            {% for t in cap.tramitemensual_set.all %}
              <span class="badge bg-secondary">{{ t.month }}: {{ t.tramites }}</span>
            {% endfor %}
          </button>
        </div>
      </div>
    </div>

    <!-- Objetivo 2 -->
    <div class="col d-flex align-items-stretch">
      <div class="card">
        <div class="card-body">
          <p class="lead">
            2. Incrementar en un 30% la implementación del modelo
            institucional de Módulos de Atención Ciudadana fijos
            de la entidad, con base en el Reporte porcentaje de
            avance en la implementación del modelo institucional vigente.
          </p>
        </div>
      </div>
    </div>

    <!-- Objetivo 3 -->
    <div class="col d-flex align-items-stretch">
      <div class="card">
        <div class="card-body">
          <p class="lead">
            3. Lograr el mantenimiento del 100% de los Módulos de Atención
            Ciudadana con modelo institucional, con base en el Reporte del
            porcentaje de avance en la implementación del modelo institucional
            vigente, en los conceptos de pintura en muros, aire acondicionado,
            marquesina, entre otros.
          </p>
        </div>
      </div>
    </div>

    <!-- Objetivo 4 -->
    <div class="col d-flex align-items-stretch">
      <div class="card">
        <div class="card-body">
          <p class="lead">
            4. Mantener el servicio a domicilio, acorde con
            lo que establece el artículo 141 de la Ley General
            de Instituciones y Procedimientos Electorales.
          </p>
        </div>
      </div>
    </div>

    <!-- Objetivo 5 -->
    <div class="col d-flex align-items-stretch">
      <div class="card">
        <div class="card-body">
          <p class="lead">
            5. Cumplir en un 95% la satisfacción ciudadana sobre
            el servicio de los Módulos de Atención Ciudadana.
          </p>
        </div>
      </div>
    </div>

  </div>
{% endblock content %}

{% block footer %}
<!-- Modal KPI#1 -->
<div class="modal fade" id="kpi1" tabindex="-1" aria-labelledby="kpi1Label" aria-hidden="true">

  <script type="text/javascript">
    google.charts.load("current", { packages: ["corechart"] });
    google.charts.setOnLoadCallback(drawChart);

    function calcularMinimoEstetico(valorMin) {
      const unidades = valorMin % 10;
      if (unidades >= 5) {
        return valorMin - unidades;
      } else {
        return valorMin - unidades - 5;
      }
    }

    function mes(n) {
      const nombres = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
      return nombres[n - 1] || '';
    }


    function drawChart() {
      const meses = [
                      {% for t in cap.tramitemensual_set.all|dictsort:"month" %}
                        '{{ t.month|stringformat:"02d" }}'{% if not forloop.last %}, {% endif %}
                      {% endfor %}
                    ];
      const tramites = [
                        {% for t in cap.tramitemensual_set.all %}
                          {{ t.tramites }}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                       ];
      const pronostico = {{ cap.forecast|default:0 }};

      let suma = 0;
      const acumulado = tramites.map(v => (suma += v));
      const porcentajeAcum = acumulado.map(v => parseFloat((v / pronostico * 100).toFixed(2)));

      const data = new google.visualization.DataTable();
      data.addColumn('string', 'Mes');
      data.addColumn('number', 'Trámites mensuales');
      data.addColumn('number', '% Acumulado');
      data.addColumn('number', 'Meta {{ cap.goal }}%');

      for (let i = 0; i < meses.length; i++) {
        data.addRow([
          mes(parseInt(meses[i])),
          tramites[i],
          porcentajeAcum[i],
          {{ cap.goal|default:0 }} // Meta del KPI#1
        ]);
      }

      const minY2 = calcularMinimoEstetico(Math.min(...porcentajeAcum));

      const options = {
        chartArea: { width: '80%', height: '70%' },
        legend: { position: 'top', alignment: 'center' },
        vAxes: {
          0: { title: 'Número de trámites', minValue: 0 },
          1: {
            title: '% Acumulado',
            viewWindow: {
              min: minY2,
              max: 100
            },
            textStyle: { color: '#d5007f' },
            titleTextStyle: { color: '#d5007f' },
            gridlines: { color: 'transparent' }
          }
        },
        seriesType: 'bars',
        series: {
          0: { targetAxisIndex: 0 }, // Trámites
          1: {
            type: 'line',
            targetAxisIndex: 1,
            color: '#d5007f',
            lineWidth: 2,
            pointSize: 5
          },
          2: {
            type: 'line',
            targetAxisIndex: 1,
            color: '#000',
            lineDashStyle: [4, 4],
            lineWidth: 1,
            pointSize: 0
          }
        },
        tooltip: { trigger: 'focus' }
      };

      const chart = new google.visualization.ComboChart(document.getElementById('chartKPI1'));
      chart.draw(data, options);
    }

    document.getElementById('kpi1').addEventListener('shown.bs.modal', function () {
      drawChart();
    });
  </script>

  <div class="modal-dialog" style="min-width: 75%;">
    <div class="modal-content" style="min-height: 600px;">
      <div class="modal-header">
        <h5 class="modal-title" id="kpi1Label">{{ cap }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body p-0" style="height: 600px;">
        <div id="chartKPI1" style="width: 100%; height: 100%;"></div>
      </div>
    </div>
  </div>
</div>
{% endblock footer %}

{% block head %}
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
{% endblock head %}
