{% extends "cerebro/base.html" %}

{% block title %}Suscripción PMML{% endblock %}

{% block content %}
<div class="flex justify-center mt-10">
    <div class="card w-full max-w-2xl bg-base-100 shadow-2xl border border-base-300">
        <div class="card-body p-10">
            <h2 class="card-title text-primary text-3xl mb-4 font-bold">Suscripción a Notificaciones</h2>

            {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} mb-6 shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>{{ message }}</span>
            </div>
            {% endfor %}
            {% endif %}

            <p class="mb-8 text-lg text-base-content/70">
                Regístrate para recibir alertas sobre actualizaciones críticas del
                <strong>Cuadro de Mando Integral (CMI)</strong>.
            </p>

            <form method="post" id="signupForm" class="space-y-6">
                {% csrf_token %}

                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text font-semibold text-lg">Nombre Completo</span>
                    </label>
                    <input type="text" name="nombre_completo" class="input input-bordered input-lg w-full focus:input-primary" placeholder="Escribe tu nombre completo" required />
                </div>

                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text font-semibold text-lg">Usuario Institucional</span>
                    </label>
                    <div class="join w-full">
                        <input type="text" name="usuario_inst" class="input input-bordered input-lg join-item w-full focus:input-primary" placeholder="Escribe tu usuario institucional" required />
                        <span class="btn btn-lg join-item no-animation bg-base-200">@ine.mx</span>
                    </div>
                    <label class="label">
                        <span class="label-text-alt text-base-content/50">Solo ingresa tu identificador, el dominio se agrega automáticamente.</span>
                    </label>
                </div>

                <div class="card-actions justify-end mt-10">
                    <button type="submit" class="btn btn-primary btn-lg px-8">
                        Suscribirse
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<dialog id="confirm_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box border-t-4 border-primary">
        <h3 class="font-bold text-2xl text-primary">Confirmación de Identidad</h3>
        <p class="py-6 text-lg">
            Estás por suscribir a: <br>
            <span id="display_email" class="font-mono font-bold text-xl text-secondary"></span>
        </p>
        <p class="text-sm text-base-content/60 italic">
            ¿Es correcto? Se enviará un enlace de activación que solo funciona en la Intranet.
        </p>
        <div class="modal-action">
            <button class="btn btn-ghost" onclick="confirm_modal.close()">Cancelar</button>
            <button id="btn_accept" class="btn btn-primary px-10">Aceptar</button>
        </div>
    </div>
</dialog>
{% endblock content %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('signupForm');
        const modal = document.getElementById('confirm_modal');
        const displayEmail = document.getElementById('display_email');
        const btnAccept = document.getElementById('btn_accept');

        form.addEventListener('submit', function (event) {
            event.preventDefault();

            const usuarioInput = document.getElementsByName('usuario_inst')[0];
            const usuario = usuarioInput.value.trim();

            if (usuario) {
                displayEmail.innerText = usuario + "@ine.mx";
                modal.showModal();
            }
        });

        btnAccept.addEventListener('click', function () {
            // Cambiamos el texto para dar feedback visual de carga
            btnAccept.innerHTML = '<span class="loading loading-spinner"></span> Enviando...';
            btnAccept.disabled = true;
            form.submit();
        });
    });
</script>
{% endblock scripts %}