{% if permission_denied %}
  <div class="space-y-4">
    <div class="alert alert-error">
      <span>No cuentas los permisos para esta actividad. Manda un correo explicando el problema a &lt;javier.sanchezt@ine.mx&gt;.</span>
    </div>
    <div class="text-right">
      <button type="button" class="btn btn-ghost" data-close-modal="profiles-user-modal">Cerrar</button>
    </div>
  </div>
{% else %}
  <form id="profiles-user-form"
        hx-post="{{ form_action }}"
        hx-target="#profiles-user-modal-content"
        hx-swap="innerHTML"
        class="space-y-6">
    {% csrf_token %}
    <header class="space-y-1">
      <h3 class="text-xl font-semibold text-base-content">Agregar usuario</h3>
      <p class="text-sm text-base-content/70">Captura los datos b√°sicos del usuario y su perfil.</p>
    </header>

    {% if form.non_field_errors %}
      <div class="alert alert-error">
        {% for error in form.non_field_errors %}
          <span>{{ error }}</span>
        {% endfor %}
      </div>
    {% endif %}

    <div class="grid gap-4 md:grid-cols-2">
      <div class="form-control">
        {{ form.first_name.label_tag }}
        {{ form.first_name }}
        {% for error in form.first_name.errors %}<p class="mt-1 text-xs text-error">{{ error }}</p>{% endfor %}
      </div>
      <div class="form-control">
        {{ form.last_name.label_tag }}
        {{ form.last_name }}
        {% for error in form.last_name.errors %}<p class="mt-1 text-xs text-error">{{ error }}</p>{% endfor %}
      </div>
      <div class="form-control">
        {{ form.email.label_tag }}
        {{ form.email }}
        {% for error in form.email.errors %}<p class="mt-1 text-xs text-error">{{ error }}</p>{% endfor %}
      </div>
      <div class="form-control">
        {{ form.username.label_tag }}
        {{ form.username }}
        {% if form.username.help_text %}<p class="mt-1 text-xs text-base-content/60">{{ form.username.help_text }}</p>{% endif %}
        {% for error in form.username.errors %}<p class="mt-1 text-xs text-error">{{ error }}</p>{% endfor %}
      </div>
      <div class="form-control md:col-span-2">
        {{ form.password.label_tag }}
        {{ form.password }}
        {% if form.password.help_text %}<p class="mt-1 text-xs text-base-content/60">{{ form.password.help_text }}</p>{% endif %}
        {% for error in form.password.errors %}<p class="mt-1 text-xs text-error">{{ error }}</p>{% endfor %}
      </div>
    </div>

    <section class="rounded-2xl border border-base-300 bg-base-100 p-4 space-y-4">
      <h4 class="text-base font-semibold text-base-content">Perfil</h4>
      <div class="grid gap-4 md:grid-cols-2">
        <div class="form-control">
          {{ form.state.label_tag }}
          {{ form.state }}
          {% for error in form.state.errors %}<p class="mt-1 text-xs text-error">{{ error }}</p>{% endfor %}
        </div>
        <div class="form-control">
          {{ form.site.label_tag }}
          {{ form.site }}
          {% for error in form.site.errors %}<p class="mt-1 text-xs text-error">{{ error }}</p>{% endfor %}
        </div>
        <div class="form-control md:col-span-2">
          {{ form.position.label_tag }}
          {{ form.position }}
          {% for error in form.position.errors %}<p class="mt-1 text-xs text-error">{{ error }}</p>{% endfor %}
        </div>
        <label class="label cursor-pointer gap-3">
          {{ form.recibe_notificaciones }}
          <span class="label-text font-semibold">{{ form.recibe_notificaciones.label }}</span>
        </label>
        {% for error in form.recibe_notificaciones.errors %}<p class="mt-1 text-xs text-error md:col-span-2">{{ error }}</p>{% endfor %}
      </div>
    </section>

    <div class="flex flex-wrap items-center gap-3">
      <button type="submit" class="btn btn-primary">Guardar usuario</button>
      <button type="button" class="btn btn-ghost" data-close-modal="profiles-user-modal">Cancelar</button>
    </div>
  </form>

  <script>
    (function () {
      const form = document.getElementById('profiles-user-form');
      if (!form) return;
      const emailInput = form.querySelector('input[name="email"]');
      const usernameInput = form.querySelector('input[name="username"]');
      if (!emailInput || !usernameInput) return;

      let lastAutoValue = usernameInput.value;
      let userEdited = false;

      usernameInput.addEventListener('input', () => {
        if (usernameInput.value !== lastAutoValue) {
          userEdited = true;
        }
      });

      emailInput.addEventListener('input', () => {
        const email = emailInput.value.trim();
        const localPart = email.includes('@') ? email.split('@')[0] : email;
        if (!localPart) {
          if (!userEdited) {
            usernameInput.value = '';
            lastAutoValue = '';
          }
          return;
        }
        if (!userEdited || !usernameInput.value.trim() || usernameInput.value === lastAutoValue) {
          usernameInput.value = localPart;
          lastAutoValue = localPart;
          userEdited = false;
        }
      });
    })();
  </script>
{% endif %}
