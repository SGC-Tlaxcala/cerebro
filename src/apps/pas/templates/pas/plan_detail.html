{% extends 'cerebro/base.html' %}

{% block title %}Plan de Acci√≥n{% endblock %}

{% block content %}
<section class="space-y-10" data-plan-id="{{ plan.pk }}">
  <div id="plan-summary"
       class="space-y-4"
       hx-get="{% url 'pas:plan-summary' plan.pk %}"
       hx-trigger="load, pas:refresh-summary from:body"
       hx-target="this"
       hx-swap="innerHTML">
    <div class="skeleton h-48 w-full rounded-3xl"></div>
  </div>

  <div id="plan-activities"
       class="space-y-4"
       hx-get="{% url 'pas:plan-activities' plan.pk %}"
       hx-trigger="load, pas:refresh-activities from:body"
       hx-target="this"
       hx-swap="innerHTML">
    <div class="skeleton h-64 w-full rounded-3xl"></div>
  </div>
</section>

<dialog id="pas-modal" class="modal">
  <div class="modal-box max-w-4xl space-y-4" id="pas-modal-content"></div>
  <form method="dialog" class="modal-backdrop">
    <button aria-label="Cerrar">Cerrar</button>
  </form>
</dialog>

<script>
  (function () {
    const modal = document.getElementById('pas-modal');
    const modalContent = document.getElementById('pas-modal-content');

    function closeModal() {
      if (!modal.open) return;
      modal.close();
      modalContent.innerHTML = '';
    }

    document.body.addEventListener('htmx:afterSwap', function (evt) {
      if (evt.target === modalContent) {
        modal.showModal();
      }
    });

    document.body.addEventListener('pas:close-modal', closeModal);

    document.body.addEventListener('click', function (evt) {
      const closeTrigger = evt.target.closest('[data-close-modal]');
      if (closeTrigger) {
        closeModal();
      }
    });

    document.body.addEventListener('htmx:beforeRequest', function (evt) {
      if (evt.detail && evt.detail.requestConfig) {
        const swapTarget = evt.detail.requestConfig.target;
        if (swapTarget && swapTarget.id === 'pas-modal-content') {
          if (!modal.open) {
            modal.showModal();
          }
        }
      }
    });
  })();
</script>
{% endblock content %}
