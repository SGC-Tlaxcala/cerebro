<div class="space-y-6">
  <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
    <div class="space-y-1">
      <h2 class="text-2xl font-semibold text-base-content">Actividades del plan</h2>
      <p class="text-sm text-base-content/70">Gestiona la ejecución y seguimiento de cada una de las actividades
        definidas.</p>
    </div>
    {% if can_modify and user.is_authenticated %}
    <button type="button" class="btn btn-primary btn-sm" hx-get="{% url 'pas:activity-add' plan.pk %}"
      hx-target="#pas-modal-content" hx-swap="innerHTML">
      Agregar actividad
    </button>
    {% endif %}
  </header>

  {% if not can_modify %}
  <div class="alert alert-warning">
    <span>El plan se encuentra cerrado o con recurrencia registrada. Las actividades están en modo de solo
      lectura.</span>
  </div>
  {% endif %}

  {% if activities %}
  <div class="overflow-x-auto">
    <table class="table table-zebra">
      <thead class="text-xs uppercase tracking-wide text-base-content/60">
        <tr>
          <th class="w-16 text-center">#</th>
          <th>Actividad</th>
          <th class="w-32 text-center">Fecha compromiso</th>
          <th class="w-32 text-center">Responsable</th>
          <th class="w-32 text-center">Seguimiento</th>
          <th class="w-32 text-center">
            <span class="inline-flex items-center justify-center gap-1">
              <span>Estado</span>
              <button type="button" class="btn btn-ghost btn-xs btn-circle text-base-content/70"
                aria-label="Ver leyenda de estados"
                onclick="document.getElementById('estado-legend-dialog').showModal()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                  stroke="currentColor" class="size-4">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093v.75m0 3.75h.008v.008H12v-.008Z" />
                  <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.5" />
                </svg>
              </button>
            </span>
          </th>
          <th class="w-32 text-center">Acciones</th>
        </tr>
      </thead>
      <tbody class="text-sm">
        {% for item in activities %}
        {% with activity=item.activity estado=item.estado %}
        <tr class="align-top">
          <td class="text-center font-semibold text-base-content/70">{{ forloop.counter }}</td>
          <td class="space-y-2">
            <div class="prose prose-sm max-w-none text-base-content/80">{{ activity.accion|safe }}</div>
            {% if activity.recursos %}
            <p class="text-xs text-base-content/60"><span class="font-semibold">Recursos:</span> {{ activity.recursos }}
            </p>
            {% endif %}
            {% if item.latest_followup %}
            <div class="rounded-lg bg-base-200/60 p-3 text-xs text-base-content/70">
              <p class="font-semibold text-base-content/80">Último seguimiento · {{
                item.latest_followup.fecha|date:'d/m/Y' }}</p>
              <p class="mt-1">{{ item.latest_followup.descripcion|safe }}</p>
            </div>
            {% endif %}
          </td>
          <td class="text-center text-base-content/80">{{ activity.fecha_fin|date:'d/m/Y'|default:'—' }}</td>
          <td class="text-center text-base-content/80">{{ activity.responsable_display|default:'—' }}</td>
          <td class="text-center text-base-content/80">
            <button type="button" class="btn btn-ghost btn-sm px-3" hx-get="{% url 'pas:followup-list' activity.pk %}"
              hx-target="#pas-modal-content" hx-swap="innerHTML">
              <span
                class="badge badge-outline badge-md min-w-[3rem] min-h-[2.5rem] items-center justify-center text-base">{{
                item.followup_count }}</span>
            </button>
          </td>
          <td class="text-center">
            {% with badge=item.badge %}
            <span class="badge badge-lg min-h-[3.125rem] items-center px-4 text-center {{ badge.classes }}"
              title="{{ badge.title }}">
              {{ badge.text }}
            </span>
            {% endwith %}
          </td>
          <td class="text-center">
            <div class="flex flex-col items-center gap-2">
              {% if can_modify and user.is_authenticated %}
              <button type="button" class="btn btn-ghost btn-xs" hx-get="{% url 'pas:activity-edit' activity.pk %}"
                hx-target="#pas-modal-content" hx-swap="innerHTML">
                Editar
              </button>
              <button type="button" class="btn btn-ghost btn-xs text-error"
                hx-get="{% url 'pas:activity-delete' activity.pk %}" hx-target="#pas-modal-content" hx-swap="innerHTML">
                Eliminar
              </button>
              {% elif not user.is_authenticated %}
              <span class="text-xs text-base-content/50">Solo lectura</span>
              {% else %}
              <span class="text-xs text-base-content/50">Plan cerrado</span>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endwith %}
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="alert alert-info">
    <div>
      <h3 class="font-semibold">No hay actividades registradas</h3>
      <p class="text-sm">Agrega la primera para comenzar a dar seguimiento al plan.</p>
    </div>
  </div>
  {% endif %}
</div>

<dialog id="estado-legend-dialog" class="modal">
  <div class="modal-box max-w-md space-y-4">
    <h3 class="text-lg font-semibold text-base-content">Leyenda de estados</h3>
    <ul class="space-y-2 text-sm text-base-content/80">
      <li class="flex items-center gap-2">
        <span class="badge badge-outline border border-warning text-base-content bg-transparent">Abierta</span>
        <span>Actividad abierta dentro del tiempo comprometido.</span>
      </li>
      <li class="flex items-center gap-2">
        <span class="badge badge-error text-error-content">Abierta</span>
        <span>Actividad abierta fuera del tiempo comprometido.</span>
      </li>
      <li class="flex items-center gap-2">
        <span class="badge badge-success text-success-content">Cerrada</span>
        <span>Actividad cerrada en tiempo.</span>
      </li>
      <li class="flex items-center gap-2">
        <span class="badge badge-success badge-outline text-success">Cerrada</span>
        <span>Actividad cerrada fuera de tiempo.</span>
      </li>
    </ul>
    <div class="text-right">
      <form method="dialog">
        <button type="submit" class="btn btn-primary btn-sm">Entendido</button>
      </form>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button aria-label="Cerrar">Cerrar</button>
  </form>
</dialog>